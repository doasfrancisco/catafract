---
title: 'Database Schema'
description: 'Azure Cosmos DB collections and data models'
---

## Overview

Catafract uses Azure Cosmos DB (SQL API) for persistent storage. The database name is `catafract` and contains **five** primary collections.

## Collections

### Users Collection

Stores user account information from Google OAuth.

**Container Name:** `users`
**Partition Key:** `/email`

#### Schema

```typescript
interface User {
  id: string;                    // UUID (auto-generated)
  email: string;                 // From Google OAuth (partition key)
  name: string;                  // From Google OAuth
  image: string;                 // Profile picture URL
  createdAt: string;             // ISO 8601 timestamp
  isPro: boolean;                // Subscription status
  provider: string;              // Always "google"
  polarCustomerId?: string;      // Polar customer ID (if subscribed)
  subscriptionStatus?: string;   // "active" | "wont-renew" | "revoked"
}
```

#### Example Document

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "name": "John Doe",
  "image": "https://lh3.googleusercontent.com/a/...",
  "createdAt": "2024-01-15T10:30:00.000Z",
  "isPro": false,
  "provider": "google"
}
```

#### Operations

- **Create:** On first Google OAuth sign-in
- **Read:** On session validation, user data fetch
- **Update:** On subscription changes via Polar webhook

---

### Projects Collection

Stores project metadata for organizing canvas workspaces.

**Container Name:** `projects`
**Partition Key:** `/userId`

#### Schema

```typescript
interface Project {
  id: string;           // UUID
  userId: string;       // Reference to user (partition key)
  name: string;         // Project name
  createdDate: Date;    // Creation timestamp
}
```

#### Example Document

```json
{
  "id": "7b2e8f45-a1c3-4d92-9f21-3b4e5f6a7c8d",
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "name": "My First Project",
  "createdDate": "2024-01-15T14:22:00.000Z"
}
```

#### Operations

- **Create:** When user creates a new project
- **Read:** When loading user's projects list
- **Update:** Not currently implemented
- **Delete:** Not currently implemented

---

### Canvas Collection

Stores the node and edge data for each project's canvas.

**Container Name:** `canvas`
**Partition Key:** `/projectId`

#### Schema

```typescript
interface Canvas {
  id: string;           // UUID
  projectId: string;    // Reference to project (partition key)
  nodes: Node[];        // Array of canvas nodes
  edges: Edge[];        // Array of connections
}

interface Node {
  id: string;
  type: 'upload' | 'generation';
  position: { x: number; y: number };
  data: {
    type: 'upload' | 'generation';
    image?: string;
    prompt?: string;
    isGenerating?: boolean;
  };
}

interface Edge {
  id: string;
  source: string;
  target: string;
  sourceHandle?: string;
  targetHandle?: string;
}
```

#### Example Document

```json
{
  "id": "9c4f2b1e-3d5a-4e8b-a7c9-1f2e3d4a5b6c",
  "projectId": "7b2e8f45-a1c3-4d92-9f21-3b4e5f6a7c8d",
  "nodes": [
    {
      "id": "upload-1",
      "type": "upload",
      "position": { "x": 100, "y": 100 },
      "data": {
        "type": "upload",
        "image": "https://catafractstorage.blob.core.windows.net/catafract/1704067200000-photo.jpg"
      }
    },
    {
      "id": "generation-1",
      "type": "generation",
      "position": { "x": 400, "y": 100 },
      "data": {
        "type": "generation",
        "prompt": "Make this image look like a watercolor painting",
        "image": "https://catafractstorage.blob.core.windows.net/catafract/generated-1704067230000.png"
      }
    }
  ],
  "edges": [
    {
      "id": "edge-1",
      "source": "upload-1",
      "target": "generation-1"
    }
  ]
}
```

#### Operations

- **Create/Upsert:** Auto-saved every 1 second (debounced)
- **Read:** When loading a project's canvas
- **Update:** Via upsert operation on every auto-save
- **Delete:** Not currently implemented

---

### Generations Collection

Stores metadata about AI-generated images for analytics and tracking.

**Container Name:** `generations`
**Partition Key:** `/userId`

#### Schema

```typescript
interface Generation {
  id: string;              // Format: "gen-{timestamp}"
  userId: string;          // User email (partition key)
  prompt: string;          // Text prompt used
  inputImages: string[];   // Array of input image URLs
  outputImageUrl: string;  // Generated image URL
  createdAt: string;       // ISO 8601 timestamp
}
```

#### Example Document

```json
{
  "id": "gen-1704067230000",
  "userId": "user@example.com",
  "prompt": "Make this image look like a watercolor painting",
  "inputImages": [
    "https://catafractstorage.blob.core.windows.net/catafract/1704067200000-photo.jpg"
  ],
  "outputImageUrl": "https://catafractstorage.blob.core.windows.net/catafract/generated-1704067230000.png",
  "createdAt": "2024-01-15T15:30:30.000Z"
}
```

#### Operations

- **Create:** After successful image generation
- **Read:** Not currently implemented (for future analytics)
- **Update:** Not implemented
- **Delete:** Not implemented

---

### Templates Collection

Stores reusable canvas templates that users can publish and share with the community.

**Container Name:** `templates`
**Partition Key:** `/templateName`

#### Schema

```typescript
interface Template {
  id: string;                 // UUID (auto-generated)
  templateName: string;       // Name given by the user (partition key)
  user: User;                 // The creator of the template
  canvas: {
    nodes: Node[];
    edges: Edge[];
    viewport: { x: number; y: number; zoom: number };
  };
  createdAt?: string;         // ISO 8601 timestamp (optional)
}
```

#### Example Document

```json
{
  "id": "c2d8f3b1-8e0d-4c3b-a1b2-123456789abc",
  "templateName": "Product Poster",
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "John Doe"
  },
  "canvas": {
    "nodes": [ /* same structure as Canvas.nodes */ ],
    "edges": [ /* same structure as Canvas.edges */ ],
    "viewport": { "x": 0, "y": 0, "zoom": 1 }
  },
  "createdAt": "2024-06-01T12:00:00.000Z"
}
```

#### Operations

- **Create:** When a user selects “Publish Template” in the canvas UI (POST `/api/upload/templates`)
- **Read:** Listed on the Projects page for Community Templates (GET `/api/upload/templates`)
- **Update:** Not currently implemented
- **Delete:** Not currently implemented

---

## Partition Key Strategy

### Why These Partition Keys?

**Users (`/email`):**
- Natural partition key as email is unique
- All queries for user data filter by email
- Even distribution across partitions

**Projects (`/userId`):**
- Users query their own projects most frequently
- Co-locates all projects for a user
- Efficient for listing user's projects

**Canvas (`/projectId`):**
- Each project has exactly one canvas
- Canvas is always loaded by project ID
- Perfect 1:1 relationship

**Generations (`/userId`):**
- Future-proofing for per-user analytics
- Can track generation history by user
- Even distribution expected

**Templates (`/templateName`):**
- Optimized for quickly querying templates by name on the Community Templates list
- Template names are expected to be unique across users (enforced at application level)

---

<!-- Remaining sections (Indexing Policy, Query Patterns, etc.) remain unchanged -->